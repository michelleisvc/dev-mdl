<script>
  const BOOKS_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSE6uzhuNaTn-QtJOl2wEoYD2p4SNWWvyYWMM_pWlM6-TuJ2crMRnw8_MqcY53ZHTMTslWroehpuk9E/pub?gid=2046680011&single=true&output=csv";

  function parseCSV(text) {
    return text
      .trim()
      .split("\n")
      .map(row => row.split(","));
  }

  function createCard({ title, author, genre, subGenre }) {
    const card = document.createElement("article");
    card.className = "book-card";

    card.innerHTML = `
      <header class="book-header">
        <h3 class="book-title">${title || "Untitled"}</h3>
        <p class="book-author">${author || "Unknown author"}</p>
      </header>
      <div class="book-meta">
        ${genre ? `<span class="book-pill">${genre}</span>` : ""}
        ${subGenre ? `<span class="book-pill">${subGenre}</span>` : ""}
      </div>
    `;
    return card;
  }

  function loadBooks() {
    const grid = document.getElementById("book-grid");
    const errorEl = document.getElementById("book-error");

    fetch(BOOKS_CSV_URL)
      .then(res => res.text())
      .then(text => {
        const rows = parseCSV(text);
        if (!rows.length) throw new Error("No data in CSV");

        const headers = rows[0].map(h => h.trim().toLowerCase());
        const titleIdx = headers.indexOf("title");
        const authorIdx = headers.indexOf("author");
        const genreIdx = headers.indexOf("genre");
        const subIdx = headers.indexOf("sub-genre");

        rows.slice(1).forEach(row => {
          const title = row[titleIdx] || "";
          const author = row[authorIdx] || "";
          const genre = row[genreIdx] || "";
          const subGenre = row[subIdx] || "";

          if (!title && !author) return;

          const card = createCard({ title, author, genre, subGenre });
          grid.appendChild(card);
        });
      })
      .catch(err => {
        console.error("Bookshelf error:", err);
        if (errorEl) errorEl.hidden = false;
      });
  }

  document.addEventListener("DOMContentLoaded", loadBooks);
</script>
